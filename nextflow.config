// Nextflow configuration file

// Pipeline metadata
manifest {
    name            = 'induce-seq-analysis'
    author          = 'Pauline Fourgoux'
    homePage        = 'https://github.com/your-org/induce-seq-analysis'
    description     = 'INDUCE-seq break analysis pipeline for AsiSI site quantification'
    mainScript      = 'main.nf'
    nextflowVersion = '>=22.10.1'
    version         = '1.2.0'
}

// Enable nf-schema plugin (latest version)
plugins {
    id 'nf-schema@2.2.1'
}

// Default parameters
params {
    // Input options
    asisi_sites     = "${projectDir}/data/chr21_AsiSI_sites.t2t.bed"
    sample_beds     = "${projectDir}/data/breaks/*.breakends.bed"
    merge_distance  = 0
    
    // Output options
    outdir          = "${projectDir}/results"
    
    // Help flag
    help            = false
    
    // Process options
    max_memory      = '8.GB'
    max_cpus        = 4
    max_time        = '240.h'
}

// Process configuration
process {
    // Global process settings
    publishDir = [
        path: { "${params.outdir}/${task.process.tokenize(':')[-1].toLowerCase()}" },
        mode: 'copy',
        saveAs: { filename -> filename.equals('versions.yml') ? null : filename }
    ]
    
    // Error strategy
    errorStrategy = 'retry'
    maxRetries = 3
    
    // Resource defaults
    cpus   = 1
    memory = '1.GB'
    time   = '1.h'
}

// Container configuration
singularity {
    enabled = true
    autoMounts = true
    cacheDir = "${projectDir}/singularity_cache"
}

docker {
    enabled = false
}

// Profiles
profiles {
    local {
        process.executor = 'local'
        process.cpus = 2
        process.memory = '4.GB'
    }
    
    docker {
        docker.enabled = true
        singularity.enabled = false
        process.container = 'ubuntu:20.04'
    }
    
    slurm {
        process.executor = 'slurm'
        process.queue = 'normal'
        process.clusterOptions = '--account=your_account'
        process.module = ['Nextflow']
    }
    
    aws {
        // AWS Batch executor configuration
        process.executor = 'awsbatch'
        process.queue = 'default'  // Set to your AWS Batch job queue
        workDir = 's3://your-bucket/nextflow-work'  // Set to your S3 bucket
        
        // AWS region and credentials (can also be set via AWS CLI/IAM roles)
        aws.region = 'us-east-1'
        aws.batch.cliPath = '/usr/local/bin/aws'
        
        // Process resource defaults for AWS Batch
        process {
            memory = '2 GB'
            cpus = 1
            time = '1h'
            
            // Override for specific processes if needed
            withName: 'MERGE_BREAKENDS|BEDTOOLS_INTERSECT' {
                memory = '4 GB'
                cpus = 2
            }
        }
        
        // Use existing containers from process definitions
        docker.enabled = true
    }
    
    test {
        params.sample_beds = "${projectDir}/data/breaks/Sample{1,2}.breakends.bed"
        params.max_memory = '2.GB'
        params.max_cpus = 1
    }
}
